---
title: "Who survived the Titanic?"
subtitle: "Factors contributing to the survival of passengers in the historic Titanic accident of 1912 "
author: "XEM Team <br> Chenyu Li, Emma Ghelfi, Maria Stylianou, Xiao Hu"
institute: "University of Edinburgh"
date: "`r Sys.Date()`"
output: 
  
  xaringan::moon_reader:
    css: xaringan-themer.css
    lib_dir: libs
    nature:
      ratio: "16:9"
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
editor_options: 
  chunk_output_type: inline
---

```{r load-packages, include = FALSE}
library(tidyverse)
library(broom)
library(here)
library(tidymodels)
library(knitr)
library(xaringanthemer)
library(dplyr)
library(vcd)
library(grid)
library(rsample)
library(ggplot2)
library(ggpol)
library(scales)
library(caret)
library(corrplot)
library(ggridges)
library(forcats)
library(scales)
library(skimr)
library(tidypredict)
library(kableExtra)
library(pscl)
```

```{r setup, include=FALSE}
# For better figure resolution
knitr::opts_chunk$set(fig.retina = 3, dpi = 300, fig.width = 6, fig.asp = 0.618, out.width = "80%")
```

```{r load-data, include=FALSE}
titanic <- read.csv(here::here("data/titanic.csv"))
glimpse(titanic)
```

```{r presentation-layout, include=FALSE}
style_xaringan(
  title_slide_background_image = "img/titanicpic.jpg" , title_slide_text_color = "ghostwhite" , background_color = "wheat2 " , text_color = "gray28"
)
```

#Table of Contents
- Background information
- Introduction to data set
- Data analysis
  - Gender vs. Survival
  - Age vs. Survival
  - Class vs. Survival
- Modelling
- Recreation of historic plot
- Bibliography

---
"Touted as the ultimate in transatlantic travel and said to be “unsinkable”, the Titanic collided with an iceberg on 14 April 1912 on her maiden voyage and sank shortly thereafter on 15 April, killing 1502 out of 2224 passengers and crew." [1]

We want to see 

### If and how the chance of survival of Titanic passengers is related to different attributes of the passengers 

---
# Data set
* The data set comes from the Awesome Public Data Sets on GitHub[2]

* There are 12 variables and 891 observations in this data set. 
--
- `Name`: Name and Surname of passenger, if available 
- `Survived`: If passenger survived (0 = No, 1 = Yes)
- `Sex`: Gender of passenger (male or female)
- `Age`: Age in years
- `Pclass`: Passenger class (1 = 1st, 2 = 2nd, 3 = 3rd) 
- `Fare`: Passenger fare (i.e. cost of ticket in USD)
- `Embarked`: Port of embarkation (C = Cherbourg, Q = Queenstown, S = Southampton)[3] 

---
class: inverse, middle, center
# Gender and Survival

---

# Introduction
* During the times when the sinking of the Titanic accident occurred (1912), in the spirit of chivalry women (and children) were saved first. This was historically recorded as orders from the captain of the Titanic.
--



* Women have higher survival rate than men. 

---

# Visualization
.pull-left[
- Use gender as the predictor variable and frequency displayed in terms of colors showing survivals or not as the outcome variable.
]

.pull-right[
```{r gender-survival,out.width="100%", fig.width=4, echo=FALSE}
titanic$Survived <- as.factor(titanic$Survived)
titanic$Pclass <- as.factor(titanic$Pclass)

titanic %>%
  ggplot(mapping = aes(x = Sex, fill = Survived)) +
  geom_bar() +
  theme_minimal() +
  scale_fill_viridis_d(name = "Survived", labels = c("No", "Yes" )) +
  labs(x = "Sex", 
       y = "Frequency", 
       title = "Survival Rate by Gender") +
  theme(legend.position = "bottom")
```
]


---
# Summary
.pull-left[
- The proportion of women passengers who survived is 0.68 
- The proportion of men passengers who survived is 0.32
]
.pull-right[
```{r survival_rate_gender,  fig.width=4, echo = FALSE}
titanic %>%
  filter(Survived == "1") %>%
  count( Sex ) %>%
  mutate(prop_survival = n/sum(n))
```
]
---

class: inverse, middle, center
# Age and Survival
---
# Introduction
- give priority to saving infants and children when it comes to providing life saving equipment

- physical abilities
---
# Data analysis 
.pull-left[
```{r age-survival,out.width="90%", fig.width=4, echo=FALSE, warning=FALSE}
titanic %>% 
  ggplot(mapping = aes(x = Age, fill = Survived)) +
  geom_histogram(binwidth = 5 ) +
  theme_minimal() +
  scale_fill_viridis_d(name = "Survived", labels = c("No", "Yes")) +
  labs(x = "Age", 
       y = "Frequency", 
       fill = "Survived", 
       title = "Survival rate by age") +
  theme(legend.position = "bottom")
```
]


.pull_right[

- Predicted variable are "Age" and "Frequency" as the outcome variable. 
- generally, the younger the more people survived.
]
---
<<<<<<< HEAD
.pull_left[
=======


.pull_left
>>>>>>> 77429d9ae70805fcb685d6a601742f69c769e0b2
```{r age-survival-rate,fig.width=6,echo=FALSE}
titanic_test <- titanic %>%
  filter(!is.na(Age))%>%
  filter(Survived == "1")%>%
  mutate(Age_Range=case_when(Age >= 0  & Age <= 10 ~ "0-10",
                               Age >= 11 & Age <= 20 ~ "11-20",
                               Age >= 21 & Age <= 30 ~ "21-30",
                               Age >= 31 & Age <= 40 ~ "31-40",
                               Age >= 41 & Age <=50 ~  "41-50",
                               Age >= 51 & Age <=60 ~  "51-60",
                               Age >= 61 & Age <= 70 ~  "61-70",
                               Age >= 71 & Age <= 80 ~ "71-80")) %>%
  count(Age_Range) %>%
  mutate(prop_survival=n/sum(n))
```

```{r, echo=FALSE}
pie(titanic_test$n,labels=round((titanic_test$prop_survival)*100,digits=4),
col=rainbow(8))
legend("topleft",legend=titanic_test$Age_Range,fill=rainbow(8))
```
]
.pull_right[
- create a new variable called "Age_Range"
- aged between 21-30 has the highest possibility to survive
- the young has more survival rate than the old 

---

class: inverse, middle, center
# Class/ Port/ Fare vs Survival
---

The class of the passenger can be considered to be a measure of their socio-economic status: based on our knowledge on the Titanic disaster we expect to find that the higher the class of the passenger, the higher their survival rate.

```{r class-survival ,echo=FALSE}
titanic %>%
  group_by(Pclass) %>%
  count(Survived) %>%
  mutate(pct = n/sum(n)*100) %>%
  mutate(pctrounded = round(pct, 2)) %>%
  ggplot(aes(x = Pclass , y = pctrounded ,  fill = Survived)) +
  geom_bar( position = position_stack(), stat = "identity", width = .7) +
  geom_text(aes(y = pct, label = pctrounded) ,position = position_stack(vjust  = 0.5), size = 3.5 ) +
  labs(x = "Class" , 
       y = "Probability of Survival" , 
       fill = "Survival", 
       title = "Survival for each Class") +
  theme_minimal()+
  theme(plot.background = element_rect(fill = "wheat")) +
   scale_fill_manual(values = c("0" = "navajowhite3",
                               "1" = "tan3"))
```

---
```{r fare-survival , echo=FALSE}
titanic %>%
  ggplot(aes(x=Pclass , y=Fare )) +
  geom_boxplot(outlier.shape = NA ) +
  geom_jitter(width = 0.2 , alpha = 0.2, size = 0.3) +
  coord_cartesian(ylim = c(0,300))+
  theme_minimal()
```

---
```{r , echo=FALSE}

  titanic_correlation <- titanic %>%
  select( Survived , Pclass , Fare) %>%
  mutate(Pclass_rank=if_else( Pclass == "3" , TRUE == "1"|
                              Pclass == "2" , TRUE == "2"|
                              Pclass == "1" , TRUE == "3"))
titanic_correlation$Pclass <- as.numeric(titanic_correlation$Pclass)
titanic_correlation$Pclass_rank <- as.numeric(titanic_correlation$Pclass_rank) 
titanic_correlation$Survived <- as.numeric(titanic_correlation$Survived)
```


```{r, echo=FALSE}

titanic_correlation_numeric <- titanic_correlation %>%
  select( Survived , Pclass_rank ,Fare)

titanic_correlation_numeric$Pclass_rank <- as.numeric(titanic_correlation_numeric$Pclass_rank)
  titanic_correlation_numeric$Survived <- as.numeric(titanic_correlation_numeric$Survived)
```



```{r , echo=FALSE}
corrplot2 <- function(titanic_correlation_numeric,
                      method = "pearson",
                      sig.level = 0.05,
                      order = "original",
                      diag = FALSE,
                      type = "upper",
                      tl.srt = 90,
                      number.font = 1,
                      number.cex = 1,
                      mar = c(0, 0, 0, 0)) {
  library(corrplot)
  titanic_correlation_numeric_incomplete <- titanic_correlation_numeric
  titanic_correlation_numeric <- titanic_correlation_numeric[complete.cases(titanic_correlation_numeric), ]
  mat <- cor(titanic_correlation_numeric, method = method)
  cor.mtest <- function(mat, method) {
    mat <- as.matrix(mat)
    n <- ncol(mat)
    p.mat <- matrix(NA, n, n)
    diag(p.mat) <- 0
    for (i in 1:(n - 1)) {
      for (j in (i + 1):n) {
        tmp <- cor.test(mat[, i], mat[, j], method = method)
        p.mat[i, j] <- p.mat[j, i] <- tmp$p.value
      }
    }
    colnames(p.mat) <- rownames(p.mat) <- colnames(mat)
    p.mat
  }
  p.mat <- cor.mtest(titanic_correlation_numeric, method = method)
  col <- colorRampPalette(c("#BB4444", "#EE9988", "#FFFFFF", "#77AADD", "#4477AA"))
  corrplot(mat,
    method = "color", col = col(200), number.font = number.font,
    mar = mar, number.cex = number.cex,
    type = type, order = order,
    addCoef.col = "black", # add correlation coefficient
    tl.col = "black", tl.srt = tl.srt, # rotation of text labels
    # combine with significance level
    p.mat = p.mat, sig.level = sig.level, insig = "blank",
    # hide correlation coefficiens on the diagonal
    diag = diag
  )
}
titanic_correlation_numeric %>%
corrplot2( 
  method = "pearson",
  sig.level = 0.05,
  order = "original",
  diag = FALSE,
  type = "upper",
  tl.srt = 75)
```

---
```{r , echo=FALSE}
 titanic %>%
filter( Embarked == "Q" | Embarked == "S" |Embarked == "C" ) %>%
group_by(Embarked) %>%
  count(Pclass) %>%
  mutate(pct = n/sum(n)*100) %>%
  mutate(pctrounded = round(pct, 2)) %>%
  ggplot(aes(x = Embarked , y = pctrounded ,  fill = Pclass)) +
  geom_bar( position = position_dodge(), stat = "identity", width = .7 )
```
---

```{r , echo=FALSE}
titanic %>%
filter( Embarked == "Q" | Embarked == "S" |Embarked == "C" ) %>%
group_by(Embarked) %>%
  count(Survived) %>%
  mutate(pct = n/sum(n)*100) %>%
  mutate(pctrounded = round(pct, 2)) %>%
    ggplot(aes(x = Embarked , y = pctrounded ,  fill = Survived)) +
  geom_bar( position = position_stack(), stat = "identity", width = .7 ) +
  geom_text(aes(y = pct, label = pctrounded) ,position = position_stack(vjust = 0.5), size = 3.5 ) 
```

---
class: inverse, center, middle

# Predictive model for survival on the titanic

---
```{r factor-variables, include=FALSE}
titanicm <- titanic %>%
  mutate(Survived = factor(Survived)) %>%
  mutate(Pclass = factor(Pclass)) 
```
```{r remove-age-na, include=FALSE}
titanic_age_na <- titanicm %>%
  filter(!is.na(Age))
```
```{r titanic-splitting, include=FALSE}
set.seed(1116)
titanic_split <- initial_split(titanic_age_na, prop = 0.80)
train_data <- training(titanic_split)
test_data  <- testing(titanic_split)
```
``` {r titanic-recipe, include=FALSE}
titanic_rec <- recipe(Survived ~ ., data = titanicm) %>%
  # PassengerId isn't predictor, but keep around to ID
  update_role(PassengerId, new_role = "ID") %>%
  # remove name and cabin
  step_rm(Name, Ticket, Cabin, SibSp, Parch, Fare, Embarked) %>%
  # remove NAs for step cut to work
  step_filter(!is.na(Age)) %>%
  # discretise age variable
  step_cut(Age, breaks = c(0, 6, 18, 54)) %>%
  # make dummy variables 
  step_dummy(all_nominal(), -all_outcomes()) %>%
  # remove zero variance predictors
  step_zv(all_predictors())
```
```{r titanic-model, include=FALSE}
titanic_mod <- logistic_reg() %>% 
  set_engine("glm")
```
```{r titanic-workflow, include=FALSE}
titanic_wflow <- workflow() %>% 
add_model(titanic_mod) %>% 
add_recipe(titanic_rec)
```

### Aim of the model 

+ 
fitting a binary logistic regression machine learning model using tidymodels library
testing the trained model’s prediction (model evaluation) strength on the unseen/test data set using various evaluation metrics.
+ parsimonious model (*Occam's razor*)

---
### Modelling Survival
+ **predictor/explanatory variables**:
  + Age
  + Passenger class
  + Gender
+ **ID variable**: passenger ID
+ **response variable**: survival
  + categorical, two levels ...
{{content}}
--
$\rightarrow$ **logistic regression modelling**
--
```{r titanic-fit-to-train, include=FALSE}
titanic_fit <- titanic_wflow %>% 
  fit(data = train_data)
```

```{r titanic-fit-to-train-display, echo=FALSE}
tidy(titanic_fit) %>%
kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = F )
```
---
.pull-left[
### Modelling Survival: Interpretation
Note: using main effects (vs. interactions) $\rightarrow$ results can still be interpreted with 3 explanatory variables.  
**Intercept**: 
> Positive intercept for baseline (i.e. female, first class passenger, aged 0-6) is expected to survive.
]
.pull-right[
```{r ref.label="titanic-fit-to-train-display", echo=FALSE}
```
]

--

Negative **Coefficents** for a term:
> All else held constant, a negative coefficient reflects a lower likelyhood of survival compared to the corresponding baseline variable. 

**Class**: 1st class $\rightarrow$ 2nd class $\rightarrow$ 3rd class

**Sex**: female $\rightarrow$ male

**Age**: children (0-6) $\rightarrow$ teenagers/ adults (6-18 and 18-54) $\rightarrow$ elderly (54 - 80)
---
```{r titanic-predict-test-data, include=FALSE}
titanic_pred <-predict(titanic_fit, test_data, type = "prob") %>%
  bind_cols(test_data %>% select(Survived, PassengerId)) 
titanic_pred
```

### 🔍 A look at what the model predicts
10 random observations from the test sample with the model's prediction and the outcome variable. 
```{r titanic-predict-test-data-table, echo=FALSE}
sample_n(titanic_pred, 10) %>%
  select(.pred_1, Survived, PassengerId) %>%
  knitr::kable(
    col.names = c("Probability to survive", "Survived", "Passenger ID"), 
    align = rep('c', 5), 
    digits = 3
    ) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), position='center', full_width = F)
```

???

looking at this a with some trial and error we've decided a cutoff proabbility of 0.6 and then plotted ROC curve ... next slide

---
###Evaluating the model: ROC curve
``` {r titanic-roc-curve, fig.height = 200, echo=FALSE}
titanic_pred %>%
  roc_curve(truth = Survived, .pred_1, event_level = "second") %>%
  autoplot()
```
---
###Evaluating the model: Statistical tests
.pull-left[
```{r sensitivity-specificity-prob, echo=FALSE}
cutoff_prob <- 0.6
titanic_pred %>%
  mutate(
    Survived      = if_else(Survived == 1, "Survived", "Not survived"),
    survived_pred  = if_else(.pred_1 > cutoff_prob, "Predicted to survive", "predicted not to survive")
    ) %>%
  count(survived_pred, Survived) %>%
  pivot_wider(names_from = Survived, values_from = n) %>%
  kable(col.names = c("", "Not Survived", "Survived"))
```

```{r prep-for-statistic-tests, include=FALSE}
titanic_results <- titanic_pred %>%
  mutate(
    survived = if_else(Survived == 1, "yes", "no"),
    survived_pred = if_else(.pred_1 > cutoff_prob, "yes", "no")
    ) %>%
  select(survived, survived_pred) 
```
&nbsp;  
``` {r statistic-tests, echo = FALSE}
custom_metrics <- metric_set(sens, spec, kap, mcc)
custom_metrics(titanic_results, 
               truth = as.factor(survived), 
               estimate = as.factor(survived_pred)) %>%
  dplyr::select(-.estimator) %>%
  knitr::kable(
    col.names = c("Metric", "Estimate"), 
    align = rep('c', 5), 
    digits = 3
    ) %>%
  kable_styling(bootstrap_options = c("striped", "hover"),  full_width = F )
```
]

.pull-right[

**Sensitivity** $=TP/(FN+TP)$

**Specificity** $=TN/(FP+TN)$

**Kappa** $\in[-1,1]$  
How much better the model is over the random classifier. (here moderate agreement)

**Matthews Correlation Coefficient (MCC)** $\in[-1,1]$  
Produces high score if the prediction obtained good results in TP, FN, TN, FP, proportionally to the size of positive elements and the size of negative elements in the dataset. (here moderate agreement)
]

---


class: inverse, center, middle

# Recreating G. Bron's "Sphere" Diagram

---
## G. Bron's original Diagram on "the Sphere", 1912
.left-column[
```{r Gbron-original-chart, echo = FALSE, out.width = "120%", fig.align = "right", fig.cap = "G.Bron's chart of 'The Loss of the Titanic', 4 May 1912." }
include_graphics("https://www.researchgate.net/profile/Michael-Friendly/publication/330916468/figure/fig1/AS:723679168196613@1549549967751/GBrons-chart-of-The-Loss-of-the-Titanic-from-The-Sphere-4-May-1912-Each-subgroup.png")
```
]
.right-column[
+ **The Sphere**: British weekly newspaper dedicated to worldwide reporting on popular issues. 
{{content}}
]
--
+ G. Bron, graphic artist, used data released the week before by the House of Commons for the visualisation pubblished **three weeks after the Titanic disaster**
{{content}}
--
+  Bron’s graph is an early innovation in data display:
{{content}}
--
    + each subgroup shown by a bar with **area proportional to the numbers of cases**
{{content}}   
--
    + Within the passenger classes, the bars are subdivided by gender for adults, while children are shown as a separate group. 
{{content}}
--
    + It also includes **summary panels**, showing the totals for passengers and crew.
{{content}}
--
+  Today: see as an early **mosaic plot**, or area-proportional back-to-back array of bar charts
---

## Recreation, mosaic plot
``` {r table-mosaic, echo=FALSE, results = 'hide'}
titanic_child <- titanic %>%
  mutate(ischild = ifelse(Age >= 18, "adult", "child"))
  
tbl <- xtabs(~Survived + Pclass + Sex + ischild, titanic_child)
ftable(tbl)
```

``` {r mosaic plot, echo = FALSE, fig.align = 'center'}
mosaic(~ Survived + Pclass + Sex + ischild, data = titanic_child, 
       highlighting = "Survived", highlighting_fill = c("#727272", "#79c36a"),
       labeling_args = list(set_varnames = c(Sex = "Gender",
                                             Survived = "Survived",
                                             Pclass = "Passenger Class",
                                             ischild = "Child")),
        set_labels = list(Survived = c("No", "Yes"),
                          Pclass = c("1st", "2nd", "3rd", "Crew"),
                          Sex = c("F", "M"),
                          ischild = c("A","C")),
       main = "Survival on the Titanic")
```


---
## Aside

.pull-left[
Brath (2018) created mosaic plots filling the tiles with the names of the victims and survivors among the 1308 passengers. 

> This highlights the fact that the passengers were people, not statistics. It's common to overlook on this while handling data that has to do with casualties.

* This is also an example of how typography could be used in data visualization.
]

.pull-right[
```{r brath2018-plot, echo=FALSE, out.width = '100%'}
knitr::include_graphics("img/brath2018.png")
```
]

.footnote[
Brath, Richard. 2018. “Text in Visualization: Extending the Visualization Design Space.” PhD thesis, London South Bank University.
]

---
#Bibliography
[1] Source: Friendly, M., Symanzik, J., &amp; Onder, O. (2019, February 6). Royal Statistical Society Publications. Royal Statistical Society. Retrieved November 19, 2021, from https://rss.onlinelibrary.wiley.com/doi/full/10.1111/j.1740-9713.2019.01229.x. 

https://rkabacoff.github.io/datavis/Models.html#Mosaic 


https://www.datavis.ca/papers/titanic/

https://www.datavis.ca/papers/titanic/ 

[2] https://github.com/awesomedata/awesome-public-datasets

[3] https://www.kaggle.com/c/titanic/data

